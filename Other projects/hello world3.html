<!DOCTYPE html>
<html>
<head>
    <meta name="description" content="Chat Guide 3.0 - Hello World">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JS Bin</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>

    <script type='text/stache' id='chat-template'>
        <div class="container">
            <div class="row">
                <div class="col-sm-8 col-sm-offset-2">
                    {{#eq page 'home'}}
                        <h1 class="page-header text-center">
                            {{message}}
                        </h1>
                        <a href="{{routeUrl page='chat'}}" class="btn btn-primary btn-block btn-lg">
                            Start chat
                        </a>
                    {{else}}
                        <chat-messages />
                    {{/eq}}
                </div>
            </div>
        </div>
    </script>
    <script type="text/stache" id="chat-messages-template">
        <h1 class="page-header text-center">
            Chat Message
        </h1>
        <a href="{{routeUrl page='home'}}" class="btn btn-primary btn-block btn-lg">
            Home
        </a>
        {{#if messagePromise.isPending}}
            <div class="list-group-item list-group-item-info">
                <h4 class="list-group-item-heading">Loading...</h4>
            </div>
        {{/if}}
        {{#if messagePromise.isRejected}}
            <div class="list-group-item list-group-item-danger">
                <h4 class="list-group3--item-heading">Error</h4>
                <p class="list-group-item-text">{{messagePromise.reason}}</p>
            </div>
        {{/if}}
        {{#if messagePromise.isResolved}}
            {{#each messagePromise.value}}
                <div class="list-group-item">
                    <h4 class="list-group3--item-heading">{{name}}</h4>
                    <p class="list-group-item-text">{{body}}</p>
                </div>
            {{else}}
            <div class="list-group-item">
                <h4 class="list-group-item-heading">No Message</h4>
            </div>
            {{/each}}
        {{/if}}
        <form class="row" ($submit)="send(%event)">
            <div class="col-sm-3">
                <input type="text" class="form-control" placeholder="Your name"
                       {($value)}="name" />
            </div>
            <div class="col-sm-6">
                <input type="text" class="form-control" placeholder="Your message"
                       {($value)}="body" />
            </div>
            <div class="col-sm-3">
                <input type="submit" class="btn btn-primary btn-block" value="Send" />
            </div>
        </form>
    </script>

    <script src="https://code.jquery.com/jquery-2.2.4.js"></script>
    <script src="https://unpkg.com/can/dist/global/can.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.js"></script>
    <script>
        var Message = can.DefineMap.extend({
            id: "number",
            name: "string",
            body: "string",
            created_at: "date"
        });
        Message.List = can.DefineList.extend({
            "#": Message
        });
        Message.connection = can.connect.superMap({
            url: {
                resource: 'http://chat.donejs.com/api/messages',
                contentType: 'application/x-www-form-urlencoded'
            },
            Map: Message,
            List: Message.List,
            name: "message"
        });
        var socket = io('http://chat.donejs.com');

        socket.on('messages created', function (message) {
            Message.connection.createInstance(message);
        });
        socket.on('messages updated', function (message) {
            Message.connection.updateInstance(message);
        });
        socket.on('messages removed', function (message) {
            Message.connection.destroyInstance(message);
        });

        var ChatMessagesVM = can.DefineMap.extend({
            messagePromise: {
                value: function () {
                    return Message.getList({});
                }
            },
            name: "string",
            body: "string",
            send: function (event) {
                event.preventDefault();

                new Message({
                    name: this.name,
                    body: this.body
                }).save().then(function () {
                    this.body = "";
                }.bind(this));
            }
        });

        can.Component.extend({
            tag: "chat-messages",
            ViewModel: ChatMessagesVM,
            view: can.stache.from("chat-messages-template")
        });
        var AppVM = can.DefineMap.extend({
            page:"string",
            message: {
                type: 'string',
                value: 'Chat Home',
                serialize:false,
            }
        });
        var appVM = new AppVM;
        can.route.data = appVM;
        can.route("{page}", { page: 'home' });
        can.route.ready();
        var template = can.stache.from("chat-template");
        var frag = template(appVM);
        document.body.appendChild(frag);
    </script>
</body>

</html>